name: E-NOR Code Request

on:
  issues:
    types: [opened, labeled]

jobs:
  implement-request:
    # Run when:
    # 1. Issue is opened with enor-request label (new request)
    # 2. enor-retry label is added (timeout retry)
    if: |
      github.event.issue.state == 'open' &&
      contains(github.event.issue.labels.*.name, 'enor-request') &&
      (github.event.action == 'opened' ||
       (github.event.action == 'labeled' && github.event.label.name == 'enor-retry'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Queue - wait for previous runs
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 30
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove retry label if present
        if: contains(github.event.issue.labels.*.name, 'enor-retry')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'enor-retry'
            })

      - name: Add comment - Starting work
        uses: actions/github-script@v7
        with:
          script: |
            const isRetry = context.payload.action === 'labeled' && context.payload.label?.name === 'enor-retry';
            const message = isRetry
              ? 'ðŸ”„ **E-NOR is retrying...** Claude Code is giving this request another go!'
              : 'ðŸ¤– **E-NOR is thinking...** Claude Code is now working on this request!';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are implementing an EXTENSION for E-NOR, a friendly robot companion.

            ## Request
            ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            ## CRITICAL RULES - READ CAREFULLY

            ### You CAN ONLY create files in extensions/ folder:
            - Create a new folder: extensions/{extension_name}/
            - Required: manifest.json with id, name, description, version, type, enabled, voice_triggers
            - Optional: handler.py, emotion.json, jokes.json, overlay.svg, sounds/, ui.html

            ### You CANNOT modify:
            - core/ folder (FORBIDDEN)
            - config/ folder (FORBIDDEN)
            - hardware/ folder (FORBIDDEN)
            - Any other existing files

            ### Extension manifest template:
            ```json
            {
              "id": "extension_id",
              "name": "Extension Name",
              "description": "What it does",
              "version": "1.0.0",
              "author": "Voice request",
              "type": "feature",
              "enabled": true,
              "voice_triggers": [{"phrases": ["trigger phrase"], "action": "action_name"}],
              "provides": {"emotions": false, "jokes": false, "overlay": false, "sounds": false, "handler": false}
            }
            ```

            ### Handler template (handler.py):
            ```python
            from core.server.extension_api import ExtensionAPI
            api = ExtensionAPI("extension_id")

            async def handle_action(action: str, params: dict):
                if action == "action_name":
                    api.speak("Response text")
                    return {"success": True}
            ```

            Please create ONLY the extension files, commit, and push to a new branch.
          allowed_tools: "Edit,Write,Read,Bash,Glob,Grep"
          timeout_minutes: 10

      - name: Add comment - Completed
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Done!** Claude Code has implemented the request. The changes will auto-deploy to E-NOR shortly!'
            })

            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            })

      - name: Add comment - Failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Oops!** Something went wrong. Dad might need to implement this one manually.'
            })

      - name: Add comment - Timed out
        if: cancelled()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'â±ï¸ **Timed out!** This request took too long (>15 min). A retry will be triggered automatically.'
            })
            // Add retry label to trigger retry workflow
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['enor-retry']
            })
