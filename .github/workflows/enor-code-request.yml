name: E-NOR Code Request

on:
  issues:
    types: [opened, labeled]

jobs:
  implement-request:
    # Run when:
    # 1. Issue is opened with enor-request label (new request)
    # 2. enor-retry label is added (timeout retry)
    if: |
      github.event.issue.state == 'open' &&
      contains(github.event.issue.labels.*.name, 'enor-request') &&
      (github.event.action == 'opened' ||
       (github.event.action == 'labeled' && github.event.label.name == 'enor-retry'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Queue - wait for previous runs
        uses: softprops/turnstyle@v2
        with:
          poll-interval-seconds: 30
          same-branch-only: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove retry label if present
        if: contains(github.event.issue.labels.*.name, 'enor-retry')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'enor-retry'
            })

      - name: Add comment - Starting work
        uses: actions/github-script@v7
        with:
          script: |
            const isRetry = context.payload.action === 'labeled' && context.payload.label?.name === 'enor-retry';
            const message = isRetry
              ? 'ðŸ”„ **E-NOR is retrying...** Claude Code is giving this request another go!'
              : 'ðŸ¤– **E-NOR is thinking...** Claude Code is now working on this request!';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are implementing a feature request for E-NOR, a friendly robot companion.

            ## Request
            ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            ## Important Guidelines
            - This is a Raspberry Pi 5 robot project for a 9-year-old named Ronnie
            - The main files are in web/index.html (frontend) and server/*.py (backend)
            - Follow existing code patterns and style
            - Keep changes minimal and focused
            - Test that existing features still work
            - Make sure the face emotions and disco mode still function

            Please implement this request, commit your changes, and push to a new branch.
          allowed_tools: "Edit,Write,Read,Bash,Glob,Grep"
          timeout_minutes: 10

      - name: Add comment - Completed
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Done!** Claude Code has implemented the request. The changes will auto-deploy to E-NOR shortly!'
            })

            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            })

      - name: Add comment - Failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Oops!** Something went wrong. Dad might need to implement this one manually.'
            })

      - name: Add comment - Timed out
        if: cancelled()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'â±ï¸ **Timed out!** This request took too long (>15 min). A retry will be triggered automatically.'
            })
            // Add retry label to trigger retry workflow
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['enor-retry']
            })
